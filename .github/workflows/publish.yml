name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop", "feature/*", "hotfix/*" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'source/Electrified.TimeSeries/Electrified.TimeSeries.csproj'
  PACKAGE_OUTPUT_DIRECTORY: ${{ github.workspace }}/output
  NUGET_SOURCE_URL: 'https://nuget.pkg.github.com/Electrified-Trading/index.json'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ—ï¸ MAIN PIPELINE: BUILD, TEST & PUBLISH
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pipeline:
    runs-on: ubuntu-latest
    outputs:
      build-successful: ${{ steps.build-current.outputs.build-successful }}
      has-changes: ${{ steps.compare-builds.outputs.has-changes }}
      previous-build-failed: ${{ steps.build-previous.outputs.previous-build-failed }}
      previous-ref: ${{ steps.build-previous.outputs.previous-ref }}
      tag-version: ${{ steps.tag-version.outputs.package-version }}
      preview-suffix: ${{ steps.preview-version.outputs.version-suffix }}
    steps:
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ—ï¸ SECTION 1: BUILD & TEST
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore Dependencies
      run: dotnet restore

    - name: Build Current
      id: build-current
      run: |
        echo "ðŸ”¨ Building current version..."
        dotnet build --configuration Debug --no-restore
        if [ $? -eq 0 ]; then
          echo "build-successful=true" >> $GITHUB_OUTPUT
          echo "âœ… Build successful"
        else
          echo "build-successful=false" >> $GITHUB_OUTPUT
          echo "âŒ Build failed"
          exit 1
        fi

    - name: Test
      if: steps.build-current.outputs.build-successful == 'true'
      run: |
        echo "ðŸ§ª Running tests..."
        dotnet test --no-build --configuration Debug --logger trx --results-directory TestResults/
        echo "âœ… Tests completed"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ” SECTION 1A: CHANGE DETECTION (Non-tag builds only)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: Build Previous Version for Comparison
      id: build-previous
      if: github.ref_type != 'tag' && github.event_name == 'push'
      run: |
        echo "ðŸ” Building previous version for comparison..."
        
        # Get previous reference
        latestTag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -n "$latestTag" ]; then
          prevRef="$latestTag"
          echo "ðŸ“Œ Comparing against latest tag: $latestTag"
        else
          prevRef="HEAD~1"
          echo "ðŸ“Œ Comparing against previous commit: HEAD~1"
        fi
        
        echo "previous-ref=$prevRef" >> $GITHUB_OUTPUT
        
        # Try to build previous version using worktree
        git worktree add ../prev-build "$prevRef" 2>/dev/null || {
          echo "âš ï¸ Could not create worktree for $prevRef - assuming first commit"
          echo "previous-build-failed=true" >> $GITHUB_OUTPUT
          exit 0
        }
        
        cd ../prev-build
        dotnet restore 2>/dev/null || {
          echo "âš ï¸ Previous version restore failed"
          echo "previous-build-failed=true" >> $GITHUB_OUTPUT
          cd "$GITHUB_WORKSPACE"
          git worktree remove ../prev-build --force 2>/dev/null || true
          exit 0
        }
        
        dotnet build --configuration Debug --no-restore 2>/dev/null || {
          echo "âš ï¸ Previous version build failed"
          echo "previous-build-failed=true" >> $GITHUB_OUTPUT
          cd "$GITHUB_WORKSPACE"
          git worktree remove ../prev-build --force 2>/dev/null || true
          exit 0
        }        
        echo "previous-build-failed=false" >> $GITHUB_OUTPUT
        echo "âœ… Previous version built successfully"
        cd "$GITHUB_WORKSPACE"

    - name: Compare Build Outputs
      id: compare-builds
      if: |
        github.ref_type != 'tag' && 
        github.event_name == 'push' && 
        steps.build-previous.outputs.previous-build-failed == 'false'
      run: |
        echo "ðŸ” Comparing build outputs..."
        
        # Run PowerShell comparison script
        pwsh -File scripts/compare-build-output.ps1 -Verbose
        comparisonResult=$?
        
        echo "DEBUG: PowerShell exit code: $comparisonResult"
        
        if [ $comparisonResult -eq 0 ]; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ No functional changes detected - jumping to summary"
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT  
          echo "âœ… Changes detected - proceeding to publish"
        fi
        
        # Cleanup worktree
        git worktree remove ../prev-build --force 2>/dev/null || true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸš€ SECTION 2: TAGGED RELEASE PUBLISHING
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: Tagged Release - Extract Version
      id: tag-version
      if: github.ref_type == 'tag' && github.event_name == 'push'
      run: |
        tagVersion="${{ github.ref_name }}"
        packageVersion="${tagVersion#v}"
        echo "package-version=$packageVersion" >> $GITHUB_OUTPUT
        echo "ðŸ·ï¸ Tag Version: $packageVersion"

    - name: Tagged Release - Build Release Configuration
      if: github.ref_type == 'tag' && github.event_name == 'push'
      run: |
        echo "ðŸ”¨ Building Release configuration for tag..."
        dotnet build --configuration Release --no-restore

    - name: Tagged Release - Pack Both Configurations
      if: github.ref_type == 'tag' && github.event_name == 'push'
      run: |
        mkdir -p ${{ env.PACKAGE_OUTPUT_DIRECTORY }}
        
        echo "ðŸ“¦ Packing Release package..."
        dotnet pack ${{ env.PROJECT_PATH }} \
          --configuration Release \
          --no-build \
          --include-symbols \
          --include-source \
          --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }} \
          -p:PackageVersion=${{ steps.tag-version.outputs.package-version }}
        
        echo "ðŸ“¦ Packing Debug package..."
        dotnet pack ${{ env.PROJECT_PATH }} \
          --configuration Debug \
          --no-build \
          --include-symbols \
          --include-source \
          --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }} \
          -p:PackageVersion=${{ steps.tag-version.outputs.package-version }}-debug

    - name: Tagged Release - Publish
      if: github.ref_type == 'tag' && github.event_name == 'push'
      run: |
        echo "ðŸš€ Publishing tagged release to GitHub Packages..."
        dotnet nuget push "${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg" \
          --source ${{ env.NUGET_SOURCE_URL }} \
          --api-key ${{ secrets.GITHUB_TOKEN }} \
          --skip-duplicate

    - name: Tagged Release - Upload Artifacts
      if: github.ref_type == 'tag' && github.event_name == 'push'
      uses: actions/upload-artifact@v4
      with:
        name: tagged-packages-${{ github.run_number }}
        path: ${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg
        retention-days: 30

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”„ SECTION 3: PREVIEW PUBLISHING (Changes detected on branches)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: Preview Publishing - Generate Version Suffix
      id: preview-version
      if: |
        github.ref_type != 'tag' && 
        github.event_name == 'push' && 
        (steps.build-previous.outputs.previous-build-failed == 'true' || 
         steps.compare-builds.outputs.has-changes == 'true')
      run: |
        branchName="${{ github.ref_name }}"
        cleanBranch=$(echo "$branchName" | sed 's/[^a-zA-Z0-9]//g')
        utcTimestamp=$(date -u +"%Y%m%d%H%M")
        versionSuffix="$cleanBranch-$utcTimestamp"
        echo "version-suffix=$versionSuffix" >> $GITHUB_OUTPUT
        echo "ðŸ”– Preview Version Suffix: $versionSuffix"

    - name: Preview Publishing - Pack Preview Package
      if: |
        github.ref_type != 'tag' && 
        github.event_name == 'push' && 
        (steps.build-previous.outputs.previous-build-failed == 'true' || 
         steps.compare-builds.outputs.has-changes == 'true')
      run: |
        mkdir -p ${{ env.PACKAGE_OUTPUT_DIRECTORY }}
        
        echo "ðŸ“¦ Packing Preview package..."
        dotnet pack ${{ env.PROJECT_PATH }} \
          --configuration Debug \
          --no-build \
          --include-symbols \
          --include-source \
          --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }} \
          --version-suffix ${{ steps.preview-version.outputs.version-suffix }}

    - name: Preview Publishing - Publish
      if: |
        github.ref_type != 'tag' && 
        github.event_name == 'push' && 
        (steps.build-previous.outputs.previous-build-failed == 'true' || 
         steps.compare-builds.outputs.has-changes == 'true')
      run: |
        echo "ðŸš€ Publishing preview package to GitHub Packages..."
        dotnet nuget push "${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg" \
          --source ${{ env.NUGET_SOURCE_URL }} \
          --api-key ${{ secrets.GITHUB_TOKEN }} \
          --skip-duplicate

    - name: Preview Publishing - Upload Artifacts
      if: |
        github.ref_type != 'tag' && 
        github.event_name == 'push' && 
        (steps.build-previous.outputs.previous-build-failed == 'true' || 
         steps.compare-builds.outputs.has-changes == 'true')
      uses: actions/upload-artifact@v4
      with:
        name: preview-packages-${{ github.run_number }}
        path: ${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg
        retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“Š SUMMARY & CLEANUP JOB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    runs-on: ubuntu-latest
    needs: pipeline
    if: always()  # Always run, even if pipeline fails
    steps:
    - name: Generate Pipeline Summary
      run: |
        echo "## ðŸš€ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.pipeline.outputs.build-successful == 'true' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ needs.pipeline.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        
        # Publishing status based on event and results
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "| Publishing | â­ï¸ Skipped (PR) |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.ref_type }}" = "tag" ]; then
          echo "| Publishing | âœ… Tagged Release Published |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.pipeline.outputs.tag-version }} |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.pipeline.outputs.has-changes }}" = "true" ] || [ "${{ needs.pipeline.outputs.previous-build-failed }}" = "true" ]; then
          echo "| Publishing | âœ… Preview Published |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Suffix | ${{ needs.pipeline.outputs.preview-suffix }} |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Publishing | â­ï¸ Skipped (No Changes) |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ needs.pipeline.outputs.previous-ref }}" ]; then
            echo "| Compared Against | ${{ needs.pipeline.outputs.previous-ref }} |" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Add flow visualization with major section bubbles
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Pipeline Flow - Major Jobs" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ [Pipeline: Build & Test] => ðŸ“Š [Summary]" >> $GITHUB_STEP_SUMMARY
          echo "   (PR - No Publishing)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.ref_type }}" = "tag" ]; then
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ [Pipeline: Build & Test + Tagged Release] => ðŸ“Š [Summary]" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.pipeline.outputs.has-changes }}" = "true" ] || [ "${{ needs.pipeline.outputs.previous-build-failed }}" = "true" ]; then
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ [Pipeline: Build & Test + Preview Publishing] => ðŸ“Š [Summary]" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ [Pipeline: Build & Test] => ðŸ“Š [Summary]" >> $GITHUB_STEP_SUMMARY
          echo "   â””â”€ No Changes - No Publishing" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add job execution details
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Job Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status | Purpose |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|---------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Pipeline | ${{ needs.pipeline.result == 'success' && 'âœ… Success' || needs.pipeline.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | Build, test, and conditional publishing |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“Š Summary | âœ… Success | Generate results summary (always runs) |" >> $GITHUB_STEP_SUMMARY
        
        # Add pipeline sections breakdown
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Pipeline Sections Executed" >> $GITHUB_STEP_SUMMARY
        echo "| Section | Status | Notes |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build & Test | ${{ needs.pipeline.outputs.build-successful == 'true' && 'âœ… Executed' || 'âŒ Failed' }} | Always runs for all events |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" != "pull_request" ] && [ "${{ github.ref_type }}" != "tag" ]; then
          echo "| ðŸ” Change Detection | âœ… Executed | Compared against ${{ needs.pipeline.outputs.previous-ref || 'previous commit' }} |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ” Change Detection | â­ï¸ Skipped | Not needed for ${{ github.event_name == 'pull_request' && 'PRs' || 'tagged releases' }} |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ github.ref_type }}" = "tag" ]; then
          echo "| ðŸš€ Tagged Release | âœ… Executed | Published Release + Debug packages |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Preview Publishing | â­ï¸ Skipped | Not needed for tagged releases |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.pipeline.outputs.has-changes }}" = "true" ] || [ "${{ needs.pipeline.outputs.previous-build-failed }}" = "true" ]; then
          echo "| ðŸš€ Tagged Release | â­ï¸ Skipped | Not a tagged release |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Preview Publishing | âœ… Executed | Published preview package |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸš€ Tagged Release | â­ï¸ Skipped | Not a tagged release |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Preview Publishing | â­ï¸ Skipped | No changes detected |" >> $GITHUB_STEP_SUMMARY
        fi
