name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop", "feature/*", "hotfix/*" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'source/Electrified.TimeSeries/Electrified.TimeSeries.csproj'
  PACKAGE_OUTPUT_DIRECTORY: ${{ github.workspace }}/output
  NUGET_SOURCE_URL: 'https://nuget.pkg.github.com/Electrified-Trading/index.json'

jobs:
  # Single streamlined job - eliminates redundant builds and dependencies
  pipeline:
    runs-on: ubuntu-latest
    steps:
    # Step A: Setup and Build
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore Dependencies
      run: dotnet restore

    - name: Build Current
      id: build-current
      run: |
        echo "ðŸ”¨ Building current version..."
        dotnet build --configuration Debug --no-restore
        if [ $? -eq 0 ]; then
          echo "build-successful=true" >> $GITHUB_OUTPUT
          echo "âœ… Build successful"
        else
          echo "build-successful=false" >> $GITHUB_OUTPUT
          echo "âŒ Build failed"
          exit 1
        fi

    # Step B: Test using existing built code
    - name: Test
      if: steps.build-current.outputs.build-successful == 'true'
      run: |
        echo "ðŸ§ª Running tests..."
        dotnet test --no-build --configuration Debug --logger trx --results-directory TestResults/
        echo "âœ… Tests completed"

    # Step C: Build previous version using worktree (for non-tags only)
    - name: Build Previous
      id: build-previous
      if: github.ref_type != 'tag' && github.event_name == 'push'
      run: |
        echo "ðŸ” Building previous version for comparison..."
        
        # Get previous reference
        latestTag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -n "$latestTag" ]; then
          prevRef="$latestTag"
          echo "ðŸ“Œ Comparing against latest tag: $latestTag"
        else
          prevRef="HEAD~1"
          echo "ðŸ“Œ Comparing against previous commit: HEAD~1"
        fi
        
        echo "previous-ref=$prevRef" >> $GITHUB_OUTPUT
        
        # Try to build previous version using worktree
        git worktree add ../prev-build "$prevRef" 2>/dev/null || {
          echo "âš ï¸ Could not create worktree for $prevRef - assuming first commit"
          echo "previous-build-failed=true" >> $GITHUB_OUTPUT
          exit 0
        }
        
        cd ../prev-build
        dotnet restore 2>/dev/null || {
          echo "âš ï¸ Previous version restore failed"
          echo "previous-build-failed=true" >> $GITHUB_OUTPUT
          cd "$GITHUB_WORKSPACE"
          git worktree remove ../prev-build --force 2>/dev/null || true
          exit 0
        }
        
        dotnet build --configuration Debug --no-restore 2>/dev/null || {
          echo "âš ï¸ Previous version build failed"
          echo "previous-build-failed=true" >> $GITHUB_OUTPUT
          cd "$GITHUB_WORKSPACE"
          git worktree remove ../prev-build --force 2>/dev/null || true
          exit 0
        }
        
        echo "previous-build-failed=false" >> $GITHUB_OUTPUT
        echo "âœ… Previous version built successfully"
        cd "$GITHUB_WORKSPACE"

    # Step D & E: Compare builds if previous succeeded (or skip if failed)
    - name: Compare Build Outputs
      id: compare-builds
      if: |
        github.ref_type != 'tag' && 
        github.event_name == 'push' && 
        steps.build-previous.outputs.previous-build-failed == 'false'
      run: |
        echo "ðŸ” Comparing build outputs..."
        
        # Run PowerShell comparison script
        pwsh -File scripts/compare-build-output.ps1 -Verbose
        comparisonResult=$?
        
        if [ $comparisonResult -eq 0 ]; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ No functional changes detected - skipping publish"
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT  
          echo "âœ… Changes detected - will publish"
        fi
        
        # Cleanup worktree
        git worktree remove ../prev-build --force 2>/dev/null || true

    # Step F: Early exit if no changes (for branches only)
    - name: Skip Publishing
      if: |
        github.ref_type != 'tag' && 
        github.event_name == 'push' && 
        steps.build-previous.outputs.previous-build-failed == 'false' &&
        steps.compare-builds.outputs.has-changes == 'false'
      run: |
        echo "## â­ï¸ Publishing Skipped" >> $GITHUB_STEP_SUMMARY
        echo "**Reason:** No functional changes detected since ${{ steps.build-previous.outputs.previous-ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Build and tests passed, no publishing needed" >> $GITHUB_STEP_SUMMARY
        echo "â­ï¸ No changes detected - workflow complete"

    # Determine publishing strategy (Tags always publish, branches only if changes or previous build failed)
    - name: Publishing Strategy
      id: publishing-strategy
      if: |
        github.event_name == 'push' && (
          github.ref_type == 'tag' ||
          (github.ref_type != 'tag' && (
            steps.build-previous.outputs.previous-build-failed == 'true' ||
            steps.compare-builds.outputs.has-changes == 'true'
          ))
        )
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          echo "strategy=tag-release" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Tag Release: Publishing stable packages"
          
          # Extract version from tag
          tagVersion="${{ github.ref_name }}"
          packageVersion="${tagVersion#v}"
          echo "package-version=$packageVersion" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Version: $packageVersion"
        else
          echo "strategy=preview-branch" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Branch Preview: Publishing preview package"
          
          # Generate preview version suffix
          branchName="${{ github.ref_name }}"
          cleanBranch=$(echo "$branchName" | sed 's/[^a-zA-Z0-9]//g')
          utcTimestamp=$(date -u +"%Y%m%d%H%M")
          versionSuffix="$cleanBranch-$utcTimestamp"
          echo "version-suffix=$versionSuffix" >> $GITHUB_OUTPUT
          echo "ðŸ”– Suffix: $versionSuffix"
        fi

    # Step G: Build Release (only for tags, reusing existing Debug build for branches)
    - name: Build Release
      if: steps.publishing-strategy.outputs.strategy == 'tag-release'
      run: |
        echo "ðŸ”¨ Building Release configuration..."
        dotnet build --configuration Release --no-restore

    - name: Pack
      if: steps.publishing-strategy.outputs.strategy != ''
      run: |
        mkdir -p ${{ env.PACKAGE_OUTPUT_DIRECTORY }}
        
        if [ "${{ steps.publishing-strategy.outputs.strategy }}" = "tag-release" ]; then
          echo "ðŸ“¦ Packing Release packages..."
          # Release package
          dotnet pack ${{ env.PROJECT_PATH }} \
            --configuration Release \
            --no-build \
            --include-symbols \
            --include-source \
            --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }} \
            -p:PackageVersion=${{ steps.publishing-strategy.outputs.package-version }}
          
          # Debug package for tags
          dotnet pack ${{ env.PROJECT_PATH }} \
            --configuration Debug \
            --no-build \
            --include-symbols \
            --include-source \
            --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }} \
            -p:PackageVersion=${{ steps.publishing-strategy.outputs.package-version }}-debug
        else
          echo "ðŸ“¦ Packing Preview package..."
          # Preview package (Debug only)
          dotnet pack ${{ env.PROJECT_PATH }} \
            --configuration Debug \
            --no-build \
            --include-symbols \
            --include-source \
            --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }} \
            --version-suffix ${{ steps.publishing-strategy.outputs.version-suffix }}
        fi

    - name: Publish
      if: steps.publishing-strategy.outputs.strategy != ''
      run: |
        echo "ðŸš€ Publishing to GitHub Packages..."
        dotnet nuget push "${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg" \
          --source ${{ env.NUGET_SOURCE_URL }} \
          --api-key ${{ secrets.GITHUB_TOKEN }} \
          --skip-duplicate

    - name: Upload Artifacts
      if: steps.publishing-strategy.outputs.strategy != ''
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ github.run_number }}
        path: ${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg
        retention-days: 30

    # Step H: Summary and Cleanup
    - name: Summary
      if: always()
      run: |
        echo "## ðŸš€ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ steps.build-current.outputs.build-successful == 'true' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "| Publishing | â­ï¸ Skipped (PR) |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ steps.publishing-strategy.outputs.strategy }}" = "" ]; then
          echo "| Publishing | â­ï¸ Skipped (No Changes) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Publishing | âœ… Published |" >> $GITHUB_STEP_SUMMARY
          echo "| Strategy | ${{ steps.publishing-strategy.outputs.strategy }} |" >> $GITHUB_STEP_SUMMARY
        fi
